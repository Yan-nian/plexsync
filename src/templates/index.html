<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plex-Trakt Sync Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 10px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-running {
            background: #fff3cd;
            color: #856404;
            animation: pulse 2s infinite;
        }

        .status-idle {
            background: #d1ecf1;
            color: #0c5460;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .stat {
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .stat-value {
            color: #333;
            font-size: 24px;
            font-weight: bold;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
            transition: transform 0.2s, opacity 0.2s;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .history-item {
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .history-item.error {
            border-left-color: #dc3545;
        }

        .history-time {
            color: #666;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .history-stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .history-stat {
            font-size: 14px;
            color: #555;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .config-label {
            color: #666;
            font-weight: 500;
        }

        .config-value {
            color: #333;
            font-family: 'Courier New', monospace;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <div class="logo">ğŸ”„</div>
                Plex-Trakt Sync Dashboard
            </h1>
            <p class="subtitle">å®æ—¶ç›‘æ§å’Œç®¡ç†æ‚¨çš„åŒæ­¥ä»»åŠ¡</p>
        </div>

        <!-- Alerts -->
        <div id="alerts"></div>

        <!-- Main Grid -->
        <div class="grid">
            <!-- Status Card -->
            <div class="card">
                <h2>ğŸ“Š å½“å‰çŠ¶æ€</h2>
                <div id="status-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        åŠ è½½ä¸­...
                    </div>
                </div>
            </div>

            <!-- Statistics Card -->
            <div class="card">
                <h2>ğŸ“ˆ æœ€è¿‘ç»Ÿè®¡</h2>
                <div id="stats-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        åŠ è½½ä¸­...
                    </div>
                </div>
            </div>

            <!-- Configuration Card -->
            <div class="card">
                <h2>âš™ï¸ é…ç½®ä¿¡æ¯</h2>
                <div id="config-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        åŠ è½½ä¸­...
                    </div>
                </div>
            </div>
        </div>

        <!-- History Card -->
        <div class="card">
            <h2>ğŸ“œ åŒæ­¥å†å²</h2>
            <div id="history-content">
                <div class="loading">
                    <div class="spinner"></div>
                    åŠ è½½ä¸­...
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Plex-Trakt Sync v1.0.0 | Made with â¤ï¸</p>
        </div>
    </div>

    <script>
        // State
        let currentStatus = null;
        let autoRefresh = null;

        // API calls
        async function fetchStatus() {
            const response = await fetch('/api/status');
            return await response.json();
        }

        async function fetchConfig() {
            const response = await fetch('/api/config');
            return await response.json();
        }

        async function fetchHistory() {
            const response = await fetch('/api/history');
            return await response.json();
        }

        async function startSync() {
            const response = await fetch('/api/sync/start', { method: 'POST' });
            return await response.json();
        }

        // Render functions
        function renderStatus(status) {
            currentStatus = status;
            
            const statusText = status.running ? 'è¿è¡Œä¸­' : 'ç©ºé—²';
            const statusClass = status.running ? 'status-running' : 
                               status.error ? 'status-error' : 'status-success';
            
            const lastSyncText = status.last_sync ? 
                new Date(status.last_sync).toLocaleString('zh-CN') : 'ä»æœªè¿è¡Œ';
            
            const content = `
                <div class="stat">
                    <span class="stat-label">åŒæ­¥çŠ¶æ€</span>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Trakt è®¤è¯</span>
                    <span class="status-badge ${status.trakt_authenticated ? 'status-success' : 'status-error'}">
                        ${status.trakt_authenticated ? 'âœ“ å·²è®¤è¯' : 'âœ— æœªè®¤è¯'}
                    </span>
                </div>
                <div class="stat">
                    <span class="stat-label">Plex è¿æ¥</span>
                    <span class="status-badge ${status.plex_connected ? 'status-success' : 'status-error'}">
                        ${status.plex_connected ? 'âœ“ å·²è¿æ¥' : 'âœ— æœªè¿æ¥'}
                    </span>
                </div>
                <div class="stat">
                    <span class="stat-label">æœ€ååŒæ­¥</span>
                    <span class="stat-value" style="font-size: 14px;">${lastSyncText}</span>
                </div>
                ${status.error ? `
                    <div class="alert alert-error" style="margin-top: 15px;">
                        <strong>é”™è¯¯:</strong> ${status.error}
                    </div>
                ` : ''}
                <button class="btn" onclick="handleStartSync()" ${status.running ? 'disabled' : ''}>
                    ${status.running ? 'â³ åŒæ­¥ä¸­...' : 'â–¶ï¸ ç«‹å³åŒæ­¥'}
                </button>
            `;
            
            document.getElementById('status-content').innerHTML = content;
        }

        function renderStats(stats) {
            if (!stats) {
                document.getElementById('stats-content').innerHTML = `
                    <div class="empty-state">æš‚æ— ç»Ÿè®¡æ•°æ®</div>
                `;
                return;
            }
            
            const content = `
                <div class="stat">
                    <span class="stat-label">Trakt ç”µå½±</span>
                    <span class="stat-value">${stats.trakt_movies || 0}</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Trakt å‰§é›†</span>
                    <span class="stat-value">${stats.trakt_episodes || 0}</span>
                </div>
                <div class="stat">
                    <span class="stat-label">åŒ¹é…ç”µå½±</span>
                    <span class="stat-value">${stats.matched_movies || 0}</span>
                </div>
                <div class="stat">
                    <span class="stat-label">åŒ¹é…å‰§é›†</span>
                    <span class="stat-value">${stats.matched_episodes || 0}</span>
                </div>
                <div class="stat">
                    <span class="stat-label">å·²æ ‡è®°è§‚çœ‹</span>
                    <span class="stat-value" style="color: #28a745;">${stats.marked_watched || 0}</span>
                </div>
                <div class="stat">
                    <span class="stat-label">è€—æ—¶</span>
                    <span class="stat-value" style="font-size: 16px;">${stats.duration || 0}s</span>
                </div>
            `;
            
            document.getElementById('stats-content').innerHTML = content;
        }

        function renderConfig(config) {
            const content = `
                <div class="config-item">
                    <span class="config-label">Plex URL</span>
                    <span class="config-value">${config.plex_url || 'N/A'}</span>
                </div>
                <div class="config-item">
                    <span class="config-label">åŒæ­¥é—´éš”</span>
                    <span class="config-value">${config.sync_interval}s (${Math.round(config.sync_interval/60)}åˆ†é’Ÿ)</span>
                </div>
                <div class="config-item">
                    <span class="config-label">Dry Run</span>
                    <span class="config-value">${config.dry_run ? 'Enabled' : 'Disabled'}</span>
                </div>
                <div class="config-item">
                    <span class="config-label">æ—¥å¿—çº§åˆ«</span>
                    <span class="config-value">${config.log_level}</span>
                </div>
                <div class="config-item">
                    <span class="config-label">åª’ä½“åº“</span>
                    <span class="config-value">${config.libraries || 'All'}</span>
                </div>
            `;
            
            document.getElementById('config-content').innerHTML = content;
        }

        function renderHistory(history) {
            if (!history || history.length === 0) {
                document.getElementById('history-content').innerHTML = `
                    <div class="empty-state">æš‚æ— åŒæ­¥å†å²</div>
                `;
                return;
            }
            
            // Show last 10
            const recentHistory = history.slice(-10).reverse();
            
            const content = recentHistory.map(item => `
                <div class="history-item ${!item.success ? 'error' : ''}">
                    <div class="history-time">
                        ${new Date(item.timestamp).toLocaleString('zh-CN')}
                        ${item.success ? 'âœ“' : 'âœ—'}
                    </div>
                    <div class="history-stats">
                        <span class="history-stat">ğŸ¬ ${item.matched_movies} ç”µå½±</span>
                        <span class="history-stat">ğŸ“º ${item.matched_episodes} å‰§é›†</span>
                        <span class="history-stat">âœ“ ${item.marked_watched} å·²æ ‡è®°</span>
                        <span class="history-stat">â±ï¸ ${item.duration}s</span>
                        ${item.errors > 0 ? `<span class="history-stat" style="color: #dc3545;">âš ï¸ ${item.errors} é”™è¯¯</span>` : ''}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('history-content').innerHTML = content;
        }

        // Event handlers
        async function handleStartSync() {
            try {
                const result = await startSync();
                showAlert('åŒæ­¥å·²å¯åŠ¨ï¼Œè¯·ç¨å€™...', 'success');
                // Refresh immediately
                await refreshAll();
            } catch (error) {
                showAlert('å¯åŠ¨åŒæ­¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'error' : 'warning'}`;
            alertDiv.textContent = message;
            
            const container = document.getElementById('alerts');
            container.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Refresh all data
        async function refreshAll() {
            try {
                const [status, config, history] = await Promise.all([
                    fetchStatus(),
                    fetchConfig(),
                    fetchHistory()
                ]);
                
                renderStatus(status);
                renderStats(status.last_stats);
                renderConfig(config);
                renderHistory(history);
            } catch (error) {
                console.error('Failed to refresh:', error);
                showAlert('åˆ·æ–°æ•°æ®å¤±è´¥', 'error');
            }
        }

        // Initialize
        async function init() {
            await refreshAll();
            
            // Auto-refresh every 5 seconds
            autoRefresh = setInterval(refreshAll, 5000);
        }

        // Start on load
        window.addEventListener('load', init);
        
        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            if (autoRefresh) clearInterval(autoRefresh);
        });
    </script>
</body>
</html>
